<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì„¸ì‚¬ê¸° ì‹¤ê±°ë˜ ë¶„ì„ê¸° (ê°•ì„œ vs ì€í‰)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; }
        .drop-zone { border: 3px dashed #1a73e8; padding: 50px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }
        .file-status { background: #f1f3f4; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; }
        .status-item { margin-bottom: 5px; color: #5f6368; }
        .status-ok { color: #188038; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #1a73e8; color: white; }
        .result-card { background: #e6fffa; border-left: 10px solid #38b2ac; padding: 20px; margin-top: 30px; border-radius: 5px; }
        .result-value { font-size: 2em; color: #e53e3e; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ  ì „ì„¸ì‚¬ê¸° DDD ë°ì´í„° ë¶„ì„ê¸°</h1>
    
    <div class="drop-zone" id="dropZone">
        ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ 8ê°œì˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”.
    </div>
    <input type="file" id="fileInput" multiple style="display:none">

    <div class="file-status" id="fileStatus">
        <strong>íŒŒì¼ ë¡œë“œ ìƒíƒœ:</strong>
        <div id="statusList">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="tableOutput"></div>
    <div id="finalOutput"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const statusList = document.getElementById('statusList');
    let results = {};

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        results = {};
        statusList.innerHTML = "";
        
        for (const file of files) {
            const fileName = file.name;
            const parts = fileName.replace('.csv', '').split('_');
            
            if (parts.length < 3) {
                statusList.innerHTML += `<div class="status-item">âš ï¸ ìŠ¤í‚µë¨: ${fileName} (ì´ë¦„ ê·œì¹™ ì˜¤ë¥˜)</div>`;
                continue;
            }

            const key = `${parts[0]}_${parts[1]}_${parts[2]}`;

            try {
                // 1. íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ì½ê¸° (EUC-KR ì²˜ë¦¬)
                const text = await readFileAsText(file, "EUC-KR");
                
                // 2. ìƒë‹¨ 15ì¤„ ì œê±° í›„ íŒŒì‹±
                const lines = text.split(/\r?\n/);
                const csvData = lines.slice(15).join('\n');

                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => {
                        let wolse = 0;
                        const data = res.data;

                        data.forEach(row => {
                            // ì»¬ëŸ¼ëª… ê³µë°± ì œê±° í›„ 'ì›”ì„¸ê¸ˆ(ë§Œì›)' ì°¾ê¸°
                            const wolseKey = Object.keys(row).find(k => k.trim().includes('ì›”ì„¸ê¸ˆ'));
                            const val = String(row[wolseKey] || "0").replace(/,/g, '');
                            if (parseInt(val) > 0) wolse++;
                        });

                        results[key] = {
                            region: parts[0], type: parts[1], year: parts[2],
                            total: data.length, wolse: wolse,
                            ratio: (wolse / data.length) * 100
                        };
                        statusList.innerHTML += `<div class="status-item status-ok">âœ… ì™„ë£Œ: ${fileName} (${data.length.toLocaleString()}ê±´)</div>`;
                        
                        if (Object.keys(results).length === files.length) {
                            render();
                        }
                    }
                });
            } catch (err) {
                statusList.innerHTML += `<div class="status-item" style="color:red">âŒ ì—ëŸ¬: ${fileName} (${err.message})</div>`;
            }
        }
    }

    function readFileAsText(file, encoding) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file, encoding);
        });
    }

    function render() {
        let html = `<table><tr><th>ì§€ì—­</th><th>ìœ í˜•</th><th>ì—°ë„</th><th>ê±°ë˜ê±´ìˆ˜</th><th>ì›”ì„¸ë¹„ì¤‘</th></tr>`;
        Object.keys(results).sort().forEach(k => {
            const r = results[k];
            html += `<tr><td>${r.region}</td><td>${r.type}</td><td>${r.year}</td><td>${r.total.toLocaleString()}</td><td>${r.ratio.toFixed(2)}%</td></tr>`;
        });
        document.getElementById('tableOutput').innerHTML = html + `</table>`;
        
        calculate();
    }

    function calculate() {
        const getR = (reg, typ, yr) => results[`${reg}_${typ}_${yr}`]?.ratio || 0;
        const ddT = (getR('gangseo','villa','2023')-getR('gangseo','villa','2021')) - (getR('gangseo','apt','2023')-getR('gangseo','apt','2021'));
        const ddC = (getR('eunpyeong','villa','2023')-getR('eunpyeong','villa','2021')) - (getR('eunpyeong','apt','2023')-getR('eunpyeong','apt','2021'));
        const ddd = ddT - ddC;

        document.getElementById('finalOutput').innerHTML = `
            <div class="result-card">
                <h2>ğŸ“Š ì‚¼ì¤‘ì°¨ë¶„(DDD) ë¶„ì„ ê²°ê³¼</h2>
                <div class="result-value">DDD Estimate: ${ddd.toFixed(2)}%p</div>
                <p>ê°•ì„œêµ¬ ë¹Œë¼ì˜ ì›”ì„¸ ì „í™˜ ì†ë„ê°€ íƒ€ ì§€ì—­/ìœ í˜• ëŒ€ë¹„ <strong>${ddd.toFixed(2)}%p</strong> ë” ê°€íŒŒë¦…ë‹ˆë‹¤.</p>
            </div>`;
    }
</script>
</body>
</html>
