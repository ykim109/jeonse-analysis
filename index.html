<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ì„¸ì‚¬ê¸° ì‹¬ì¸µ DDD ë¶„ì„ê¸° (Academic Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

<div class="max-w-5xl mx-auto">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-slate-900 mb-2">ğŸ  ì „ì„¸ì‚¬ê¸° ì‹¬ì¸µ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
        <p class="text-slate-500 text-lg">ê¸°ì´ˆ DDD ë¶„ì„ + ì‹œì¥ ë³€ë™ì„± ë° ê°€ê²© ë©”ì»¤ë‹ˆì¦˜ ë¶„ì„</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4">ë¶„ì„ ì„¤ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase">ê¸°ì¤€ ì—°ë„</label>
                    <select id="baseYear" class="w-full mt-1 p-2 bg-slate-50 border rounded-lg outline-none">
                        <option value="2021" selected>2021ë…„</option>
                        <option value="2022">2022ë…„</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase">ë¹„êµ ì—°ë„</label>
                    <select id="targetYear" class="w-full mt-1 p-2 bg-slate-50 border rounded-lg outline-none">
                        <option value="2023">2023ë…„</option>
                        <option value="2024">2024ë…„</option>
                        <option value="2025" selected>2025ë…„</option>
                    </select>
                </div>
                <div id="dropZone" class="border-2 border-dashed p-4 rounded-xl text-center cursor-pointer hover:bg-blue-50">
                    <input type="file" id="fileInput" multiple class="hidden">
                    <p class="text-sm font-bold text-blue-600">CSV íŒŒì¼ ì—…ë¡œë“œ</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-rose-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
                í•™ìˆ ì  ì¸ì‚¬ì´íŠ¸ (Market Analysis)
            </h3>
            <div id="insightPanel" class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-slate-50 rounded-xl">
                    <p class="text-xs text-slate-400 font-bold uppercase">ë¹Œë¼ ë³€ë™ì„± (CV)</p>
                    <p id="villaVol" class="text-2xl font-black text-slate-700">-</p>
                    <p class="text-[10px] text-slate-400 mt-1">* ë†’ì„ìˆ˜ë¡ ì‹œì¥ ë¶ˆì•ˆì •</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl">
                    <p class="text-xs text-slate-400 font-bold uppercase">ì•„íŒŒíŠ¸ ë³€ë™ì„± (CV)</p>
                    <p id="aptVol" class="text-2xl font-black text-slate-700">-</p>
                    <p class="text-[10px] text-slate-400 mt-1">* 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì•ˆì •ì </p>
                </div>
            </div>
        </div>
    </div>

    <div id="chartContainer" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
        <canvas id="trendChart" class="h-[300px]"></canvas>
    </div>

    <div id="finalOutput" class="hidden mb-8"></div>
    <div id="tableContainer" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
                <tr><th class="px-6 py-3">ì§€ì—­/ìœ í˜•</th><th class="px-6 py-3">ì—°ë„</th><th class="px-6 py-3">ì›”ì„¸ë¹„ì¤‘</th><th class="px-6 py-3">í‰ê· ë³´ì¦ê¸ˆ</th><th class="px-6 py-3">í‰ê· ì›”ì„¸</th></tr>
            </thead>
            <tbody id="tableBody" class="text-sm divide-y"></tbody>
        </table>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    let results = {};
    let trendChart = null;

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        results = {};
        for (const file of Array.from(files)) {
            const parts = file.name.toLowerCase().replace('.csv', '').split('_');
            if (parts.length < 3) continue;
            const key = `${parts[0]}_${parts[1]}_${parts[2]}`;
            const text = await readFileAsText(file, "EUC-KR");
            parseAndProcess(text, key, parts);
        }
    }

    function parseAndProcess(text, key, parts) {
        const lines = text.split(/\r?\n/).slice(15).join('\n');
        Papa.parse(lines, {
            header: true,
            skipEmptyLines: true,
            complete: (res) => {
                let wolseCount = 0;
                let sumDeposit = 0, sumRent = 0;
                
                res.data.forEach(row => {
                    const depositKey = Object.keys(row).find(k => k.includes('ë³´ì¦ê¸ˆ'));
                    const rentKey = Object.keys(row).find(k => k.includes('ì›”ì„¸ê¸ˆ'));
                    const dep = parseInt(String(row[depositKey] || "0").replace(/[^0-9]/g, '')) || 0;
                    const rent = parseInt(String(row[rentKey] || "0").replace(/[^0-9]/g, '')) || 0;

                    sumDeposit += dep;
                    sumRent += rent;
                    if (rent > 0) wolseCount++;
                });

                results[key] = {
                    region: parts[0], type: parts[1], year: parts[2],
                    ratio: (wolseCount / res.data.length) * 100,
                    avgDep: sumDeposit / res.data.length,
                    avgRent: sumRent / res.data.length
                };
                updateUI();
            }
        });
    }

    function updateUI() {
        renderTable();
        renderChart();
        if (Object.keys(results).length >= 4) {
            calculateDDD();
            calculateVariability(); // ì¶”ê°€ëœ ë³€ë™ì„± ê³„ì‚°
        }
    }

    // ğŸ“ˆ ì‹œì¥ ë³€ë™ì„±(CV) ê³„ì‚° í•¨ìˆ˜
    function calculateVariability() {
        const years = ['2021', '2022', '2023', '2024', '2025'];
        
        const getCV = (type) => {
            const values = years.map(y => (results[`gangseo_${type}_${y}`]?.ratio || results[`eunpyeong_${type}_${y}`]?.ratio)).filter(v => v);
            if (values.length < 2) return null;
            const mean = values.reduce((a, b) => a + b) / values.length;
            const std = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / values.length);
            return (std / mean).toFixed(3);
        };

        const vVol = getCV('villa');
        const aVol = getCV('apt');
        document.getElementById('villaVol').innerText = vVol || '-';
        document.getElementById('aptVol').innerText = aVol || '-';
    }

    function calculateDDD() {
        const base = document.getElementById('baseYear').value;
        const target = document.getElementById('targetYear').value;
        const getR = (r, t, y) => results[`${r}_${t}_${y}`]?.ratio || 0;
        
        const ddT = (getR('gangseo','villa',target)-getR('gangseo', 'villa', base)) - (getR('gangseo','apt',target)-getR('gangseo','apt',base));
        const ddC = (getR('eunpyeong','villa',target)-getR('eunpyeong','villa',base)) - (getR('eunpyeong','apt',target)-getR('eunpyeong','apt',base));
        const ddd = ddT - ddC;

        const out = document.getElementById('finalOutput');
        out.classList.remove('hidden');
        out.innerHTML = `
            <div class="bg-slate-900 rounded-2xl p-6 text-white shadow-xl">
                <h3 class="text-xl font-bold mb-2">ìµœì¢… DDD Estimate: <span class="text-blue-400">${ddd.toFixed(2)}%p</span></h3>
                <p class="text-slate-400 text-sm">í•´ë‹¹ ìˆ˜ì¹˜ëŠ” ê¸ˆë¦¬ ë“± ì™¸ë¶€ ìš”ì¸ì„ ì œê±°í•œ ì „ì„¸ì‚¬ê¸°ì˜ ìˆœìˆ˜ ì‹œì¥ ì¶©ê²©ëŸ‰ì…ë‹ˆë‹¤.</p>
            </div>`;
    }

    function renderTable() {
        const body = document.getElementById('tableBody');
        document.getElementById('tableContainer').classList.remove('hidden');
        body.innerHTML = Object.keys(results).sort().map(k => {
            const r = results[k];
            return `<tr class="hover:bg-slate-50">
                <td class="px-6 py-3 font-bold">${r.region}_${r.type}</td>
                <td class="px-6 py-3">${r.year}</td>
                <td class="px-6 py-3 text-blue-600 font-bold">${r.ratio.toFixed(2)}%</td>
                <td class="px-6 py-3">${Math.round(r.avgDep).toLocaleString()}ë§Œì›</td>
                <td class="px-6 py-3">${Math.round(r.avgRent).toLocaleString()}ë§Œì›</td>
            </tr>`;
        }).join('');
    }

    // Chart.js ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function renderChart() {
        document.getElementById('chartContainer').classList.remove('hidden');
        const ctx = document.getElementById('trendChart').getContext('2d');
        const years = ['2021', '2022', '2023', '2024', '2025'];
        const getS = (reg, typ) => years.map(y => results[`${reg}_${typ}_${y}`]?.ratio || null);

        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    { label: 'ê°•ì„œ ë¹Œë¼', data: getS('gangseo', 'villa'), borderColor: '#ef4444', borderWidth: 3 },
                    { label: 'ì€í‰ ë¹Œë¼', data: getS('eunpyeong', 'villa'), borderColor: '#3b82f6', borderWidth: 3 }
                ]
            },
            options: { maintainAspectRatio: false }
        });
    }

    function readFileAsText(file, encoding) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsText(file, encoding);
        });
    }
</script>
</body>
</html>
