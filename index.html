<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì„¸ì‚¬ê¸° DDD ë¶„ì„ê¸° (ê°•ì„œ vs ì€í‰)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
        .drop-zone { border: 3px dashed #1a73e8; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; cursor: pointer; }
        .drop-zone:hover { background: #e8f0fe; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #1a73e8; color: white; }
        .result-section { margin-top: 30px; padding: 25px; background: #e6fffa; border-left: 8px solid #38b2ac; }
        .metric { font-size: 1.8em; font-weight: bold; color: #e53e3e; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“Š ì „ì„¸ì‚¬ê¸° DDD ë¶„ì„ê¸° (ìµœì¢… ìˆ˜ì •ë³¸)</h1>
    <p>ê°•ì„œêµ¬ì™€ ì€í‰êµ¬ì˜ 2021, 2023 ì‹¤ê±°ë˜ íŒŒì¼ì„ í•œêº¼ë²ˆì— ì„ íƒí•˜ì„¸ìš”.</p>
    
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <strong>ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš” (8ê°œ íŒŒì¼)</strong>
    </div>
    <input type="file" id="fileInput" multiple style="display:none" onchange="handleFiles(this.files)">

    <div id="status"></div>
    <div id="tableOutput"></div>
    <div id="analysisOutput" class="result-section" style="display:none"></div>
</div>

<script>
    let results = {};

    async function handleFiles(files) {
        results = {};
        document.getElementById('status').innerText = "â³ ë°ì´í„° ë¶„ì„ ì¤‘...";
        
        for (const file of files) {
            const parts = file.name.replace('.csv', '').split('_');
            if (parts.length < 3) continue;
            const key = `${parts[0]}_${parts[1]}_${parts[2]}`;

            await new Promise(resolve => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "EUC-KR", // í•œê¸€ ê¹¨ì§ ë°©ì§€
                    beforeFirstChunk: function(chunk) {
                        // 15ì¤„ ìŠ¤í‚µ (ì •í™•í•˜ê²Œ ì¤„ë°”ê¿ˆ ê¸°í˜¸ ëŒ€ì‘)
                        const lines = chunk.split(/\r?\n/);
                        return lines.slice(15).join('\n');
                    },
                    complete: function(res) {
                        let wolseCount = 0;
                        let totalCount = res.data.length;

                        res.data.forEach(row => {
                            // ì»¬ëŸ¼ëª…ì—ì„œ ê³µë°±ì´ë‚˜ ì¤„ë°”ê¿ˆ ì œê±° í›„ ê°’ ì¶”ì¶œ
                            const getVal = (name) => {
                                for (let k in row) {
                                    if (k.trim() === name) return row[k];
                                }
                                return "0";
                            };

                            const rawVal = getVal('ì›”ì„¸ê¸ˆ(ë§Œì›)');
                            const val = String(rawVal).replace(/,/g, '').trim();
                            if (parseInt(val) > 0) wolseCount++;
                        });

                        results[key] = {
                            region: parts[0], type: parts[1], year: parts[2],
                            total: totalCount, wolse: wolseCount,
                            ratio: totalCount > 0 ? (wolseCount / totalCount) * 100 : 0
                        };
                        resolve();
                    }
                });
            });
        }
        render();
    }

    function render() {
        let html = `<table><tr><th>ì§€ì—­</th><th>ìœ í˜•</th><th>ì—°ë„</th><th>ì´ ê±°ë˜</th><th>ì›”ì„¸ ê±´ìˆ˜</th><th>ì›”ì„¸ ë¹„ì¤‘</th></tr>`;
        Object.keys(results).sort().forEach(k => {
            const r = results[k];
            html += `<tr><td>${r.region}</td><td>${r.type}</td><td>${r.year}</td><td>${r.total}</td><td>${r.wolse}</td><td>${r.ratio.toFixed(2)}%</td></tr>`;
        });
        document.getElementById('tableOutput').innerHTML = html + `</table>`;
        calculateDDD();
    }

    function calculateDDD() {
        const getR = (reg, typ, yr) => results[`${reg}_${typ}_${yr}`]?.ratio || 0;
        
        // ê°•ì„œêµ¬(ì²˜ì¹˜) ë³€í™”
        const ddT = (getR('gangseo','villa','2023')-getR('gangseo','villa','2021')) - (getR('gangseo','apt','2023')-getR('gangseo','apt','2021'));
        // ì€í‰êµ¬(ëŒ€ì¡°) ë³€í™”
        const ddC = (getR('eunpyeong','villa','2023')-getR('eunpyeong','villa','2021')) - (getR('eunpyeong','apt','2023')-getR('eunpyeong','apt','2021'));
        
        const ddd = ddT - ddC;
        const out = document.getElementById('analysisOutput');
        out.style.display = 'block';
        out.innerHTML = `
            <h2>ğŸ¯ ë¶„ì„ ê²°ê³¼</h2>
            <div class="metric">DDD Estimate: ${ddd.toFixed(2)}%p</div>
            <p><strong>í•´ì„:</strong> ê¸ˆë¦¬ ìš”ì¸ì„ ë°°ì œí•œ ì „ì„¸ì‚¬ê¸° ìˆœìˆ˜ íš¨ê³¼ë¡œ ì¸í•´ ê°•ì„œêµ¬ ë¹Œë¼ì˜ ì›”ì„¸ ì „í™˜ì´ <strong>${ddd.toFixed(2)}%p</strong> ë” ê°•ë ¥í•˜ê²Œ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
        `;
        document.getElementById('status').innerText = "âœ… ë¶„ì„ ì™„ë£Œ";
    }
</script>
</body>
</html>
