<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì„¸ì‚¬ê¸° DDD ë¶„ì„ê¸° (ê°•ì„œ vs ì€í‰)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: 0 auto; background: #f4f7f6; }
        .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .drop-zone { border: 2px dashed #3498db; padding: 30px; text-align: center; margin: 20px 0; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #3498db; color: white; }
        .result-box { margin-top: 20px; padding: 20px; background: #e8f6f3; border-left: 5px solid #1abc9c; }
    </style>
</head>
<body>
<div class="card">
    <h1>ğŸ“Š ì „ì„¸ì‚¬ê¸° ì‹¤ê±°ë˜ ë¶„ì„ (ê°•ì„œ vs ì€í‰)</h1>
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        CSV íŒŒì¼ 8ê°œë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.
    </div>
    <input type="file" id="fileInput" multiple style="display:none" onchange="handleFiles(this.files)">
    <div id="tableOutput"></div>
    <div id="dddOutput" class="result-box" style="display:none"></div>
</div>

<script>
    let results = {};
    async function handleFiles(files) {
        results = {};
        for (const file of files) {
            const parts = file.name.replace('.csv', '').split('_');
            if(parts.length < 3) continue;
            const key = `${parts[0]}_${parts[1]}_${parts[2]}`;
            await new Promise(resolve => {
                Papa.parse(file, {
                    header: true, skipEmptyLines: true,
                    beforeFirstChunk: chunk => chunk.split('\n').slice(15).join('\n'),
                    complete: res => {
                        let wolse = 0;
                        res.data.forEach(r => {
                            const val = String(r['ì›”ì„¸ê¸ˆ(ë§Œì›)'] || r['ì›”ì„¸(ë§Œì›)'] || "0").replace(/,/g, '');
                            if (parseInt(val) > 0) wolse++;
                        });
                        results[key] = { ratio: (wolse / res.data.length) * 100 };
                        resolve();
                    }
                });
            });
        }
        render();
    }

    function render() {
        let html = `<table><tr><th>ì§€ì—­</th><th>ìœ í˜•</th><th>ì—°ë„</th><th>ì›”ì„¸ ë¹„ì¤‘</th></tr>`;
        Object.keys(results).sort().forEach(k => {
            const [reg, typ, yr] = k.split('_');
            html += `<tr><td>${reg}</td><td>${typ}</td><td>${yr}</td><td>${results[k].ratio.toFixed(2)}%</td></tr>`;
        });
        document.getElementById('tableOutput').innerHTML = html + `</table>`;
        
        const getR = (reg, typ, yr) => results[`${reg}_${typ}_${yr}`]?.ratio || 0;
        const ddT = (getR('gangseo','villa','2023')-getR('gangseo','villa','2021')) - (getR('gangseo','apt','2023')-getR('gangseo','apt','2021'));
        const ddC = (getR('eunpyeong','villa','2023')-getR('eunpyeong','villa','2021')) - (getR('eunpyeong','apt','2023')-getR('eunpyeong','apt','2021'));
        
        const ddd = document.getElementById('dddOutput');
        ddd.style.display = 'block';
        ddd.innerHTML = `<h3>ìµœì¢… DDD ê²°ê³¼: ${(ddT - ddC).toFixed(2)}%p</h3><p>ê°•ì„œêµ¬ ë¹Œë¼ì—ì„œ ì „ì„¸ì‚¬ê¸°ë¡œ ì¸í•´ ì¶”ê°€ ë°œìƒí•œ ì›”ì„¸ ì „í™˜ íš¨ê³¼ì…ë‹ˆë‹¤.</p>`;
    }
</script>
</body>
</html>
