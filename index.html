<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì„¸ì‚¬ê¸° DDD ë¶„ì„ê¸° (ê°•ì„œ vs ì€í‰)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
        .drop-zone { border: 3px dashed #1a73e8; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; cursor: pointer; }
        .drop-zone:hover { background: #e8f0fe; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #1a73e8; color: white; }
        .result-section { margin-top: 30px; padding: 25px; background: #e6fffa; border-left: 8px solid #38b2ac; }
        .metric { font-size: 1.8em; font-weight: bold; color: #e53e3e; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“Š ì „ì„¸ì‚¬ê¸° DDD ë¶„ì„ê¸° (V3.0 - ë¬´ì  ë²„ì „)</h1>
    <p>8ê°œì˜ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë°ì´í„° ì¸ì½”ë”©ê³¼ ìœ ë ¹ ë¬¸ìë¥¼ ìë™ìœ¼ë¡œ ì •ì œí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.</p>
    
    <div class="drop-zone" id="dropZone">
        <strong>íŒŒì¼ 8ê°œë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”.</strong>
    </div>
    <input type="file" id="fileInput" multiple style="display:none">

    <div id="status"></div>
    <div id="tableOutput"></div>
    <div id="analysisOutput" class="result-section" style="display:none"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    let results = {};

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        results = {};
        document.getElementById('status').innerText = "â³ ì •ë°€ ë¶„ì„ ì¤‘...";
        
        for (const file of files) {
            const parts = file.name.replace('.csv', '').split('_');
            if (parts.length < 3) continue;
            const key = `${parts[0]}_${parts[1]}_${parts[2]}`;

            await new Promise(resolve => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "EUC-KR",
                    beforeFirstChunk: chunk => chunk.split(/\r?\n/).slice(15).join('\n'), // 15ì¤„ ìŠ¤í‚µ
                    complete: res => {
                        let wolseCount = 0;
                        const rows = res.data;

                        // ğŸ” ì»¬ëŸ¼ëª… ìœ ì—°í•˜ê²Œ ì°¾ê¸° (ì›”ì„¸ê¸ˆ ë˜ëŠ” ì›”ì„¸ í¬í•¨ëœ ì»¬ëŸ¼)
                        let wolseKey = null;
                        if (rows.length > 0) {
                            wolseKey = Object.keys(rows[0]).find(k => k.includes('ì›”ì„¸'));
                        }

                        rows.forEach(row => {
                            if (!wolseKey) return;
                            const val = String(row[wolseKey]).replace(/,/g, '').trim();
                            if (parseInt(val) > 0) wolseCount++;
                        });

                        results[key] = {
                            region: parts[0], type: parts[1], year: parts[2],
                            total: rows.length, wolse: wolseCount,
                            ratio: rows.length > 0 ? (wolseCount / rows.length) * 100 : 0
                        };
                        resolve();
                    }
                });
            });
        }
        render();
    }

    function render() {
        let html = `<table><tr><th>ì§€ì—­</th><th>ìœ í˜•</th><th>ì—°ë„</th><th>ì´ ê±°ë˜</th><th>ì›”ì„¸ ê±´ìˆ˜</th><th>ì›”ì„¸ ë¹„ì¤‘</th></tr>`;
        Object.keys(results).sort().forEach(k => {
            const r = results[k];
            html += `<tr><td>${r.region}</td><td>${r.type}</td><td>${r.year}</td><td>${r.total}</td><td>${r.wolse}</td><td>${r.ratio.toFixed(2)}%</td></tr>`;
        });
        document.getElementById('tableOutput').innerHTML = html + `</table>`;
        calculateDDD();
    }

    function calculateDDD() {
        const getR = (reg, typ, yr) => results[`${reg}_${typ}_${yr}`]?.ratio || 0;
        const ddT = (getR('gangseo','villa','2023')-getR('gangseo','villa','2021')) - (getR('gangseo','apt','2023')-getR('gangseo','apt','2021'));
        const ddC = (getR('eunpyeong','villa','
